document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("vehiclesGrid"),t=document.getElementById("loading"),n=document.getElementById("searchInput"),a=document.getElementById("pagination"),o={trigger:document.getElementById("brandTrigger"),menu:document.getElementById("brandMenu"),selectedText:document.getElementById("selectedBrand"),container:document.getElementById("brandDropdown")},s={trigger:document.getElementById("yearTrigger"),menu:document.getElementById("yearMenu"),selectedText:document.getElementById("selectedYear"),container:document.getElementById("yearDropdown")};if(!e||!t||!n)return void console.error("Critical elements missing from DOM");function r(){window.innerWidth<768?n.placeholder="Search brand, model, year...":n.placeholder="Search brand, model, or year... (e.g. Toyota Camry)"}r(),window.addEventListener("resize",r);let c=[],i=[],l=1;let d="",m="";const u={toyota:"fa-car",honda:"fa-car-side",bmw:"fa-circle",mercedes:"fa-star",audi:"fa-ring",ford:"fa-truck-pickup",chevrolet:"fa-plus",nissan:"fa-circle-notch",hyundai:"fa-italic",kia:"fa-k",volkswagen:"fa-v",mazda:"fa-m",subaru:"fa-star-of-life",lexus:"fa-l",jeep:"fa-mountain",dodge:"fa-bolt",ram:"fa-sheep",gmc:"fa-truck",cadillac:"fa-shield-alt",buick:"fa-shield-alt",acura:"fa-a",infiniti:"fa-infinity",lincoln:"fa-star",volvo:"fa-arrow-circle-up","land rover":"fa-compass",jaguar:"fa-cat",porsche:"fa-horse",mini:"fa-car-compact",mitsubishi:"fa-shapes",tesla:"fa-bolt",fiat:"fa-f","alfa romeo":"fa-cross",genesis:"fa-wing",chrysler:"fa-copyright"};function p(e){return u[e.toLowerCase()]||"fa-car"}function f(e,t,n){const{menu:a,selectedText:o,trigger:s,container:r}=e;a&&o&&s&&r?(a.innerHTML=`<div class="dropdown-item active" data-value="">All ${n}s</div>`,t.forEach(e=>{const t=document.createElement("div");t.className="dropdown-item",t.dataset.value=e,t.innerHTML=`\n                <span>${e}</span>\n            `,a.appendChild(t)}),s.onclick=e=>{e.stopPropagation();const t=a.classList.contains("open");h(null),t||(a.classList.add("open"),s.classList.add("active"))},a.querySelectorAll(".dropdown-item").forEach(e=>{e.onclick=t=>{t.stopPropagation(),a.querySelectorAll(".dropdown-item").forEach(e=>e.classList.remove("active")),e.classList.add("active");const r=e.dataset.value;o.textContent=r||`All ${n}s`,"Brand"===n&&(d=r),"Year"===n&&(m=r),a.classList.remove("open"),s.classList.remove("active"),v()}})):console.warn(`Dropdown elements missing for ${n}`)}function h(e){[o,s].forEach(t=>{t.container!==e&&(t.menu.classList.remove("open"),t.trigger.classList.remove("active"))})}function v(){const e=n.value.toLowerCase().trim();i=c.filter(t=>{const n=`${t.brand} ${t.model} ${t.year}`.toLowerCase(),a=!e||n.includes(e),o=!d||t.brand===d,s=!m||t.year===m;return a&&o&&s}),l=1,g(),L()}function g(){const t=24*(l-1),a=t+24,o=i.slice(t,a),s=n.value.trim();if(e.innerHTML="",0===o.length)return void(e.innerHTML='\n                <div class="empty-state">\n                    <i class="fas fa-search empty-icon"></i>\n                    <h3>No vehicles found</h3>\n                    <p>Try adjusting your search or filters.</p>\n                </div>\n            ');const r=document.createDocumentFragment();o.forEach((e,t)=>{const n=document.createElement("div");n.className="vehicle-card",n.style.animationDelay=.03*t+"s";const a=p(e.brand),o=function(e,t){if(!t)return y(e);const n=new RegExp(`(${t})`,"gi");return y(e).replace(n,'<span class="highlight">$1</span>')}(e.model,s);n.innerHTML=`\n                <div class="card-header">\n                    <div class="brand-badge" title="${y(e.brand)}">\n                        <i class="fas ${a}"></i>\n                    </div>\n                    <span class="year-badge">${y(e.year)}</span>\n                </div>\n                <h3 class="model-name">${o}</h3>\n                <div class="card-footer">\n                    <button class="view-btn" onclick="location.href='index.html#contact'">\n                        Reserve <i class="fas fa-check-circle"></i>\n                    </button>\n                </div>\n            `,r.appendChild(n)}),e.appendChild(r)}function y(e){return e?e.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):""}function L(){const e=Math.ceil(i.length/24);if(a.innerHTML="",e<=1)return;const t=(e,t,n=!1,a=!1)=>{const o=document.createElement("button");return o.className="page-btn "+(a?"active":""),o.innerHTML=t,o.disabled=n,n||(o.onclick=()=>{l=e,g(),L(),window.scrollTo({top:0,behavior:"smooth"})}),o};a.appendChild(t(l-1,'<i class="fas fa-chevron-left"></i>',1===l));let n=Math.max(1,l-2),o=Math.min(e,n+4);if(o-n<4&&(n=Math.max(1,o-4)),n>1&&(a.appendChild(t(1,"1")),n>2)){const e=document.createElement("span");e.textContent="...",e.style.alignSelf="center",e.style.color="var(--text-secondary)",a.appendChild(e)}for(let e=n;e<=o;e++)a.appendChild(t(e,e,!1,e===l));if(o<e){if(o<e-1){const e=document.createElement("span");e.textContent="...",e.style.alignSelf="center",e.style.color="var(--text-secondary)",a.appendChild(e)}a.appendChild(t(e,e))}a.appendChild(t(l+1,'<i class="fas fa-chevron-right"></i>',l===e))}fetch("../DATA/vehicles.csv").then(e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.text()}).then(e=>{c=function(e){const t=e.split("\n"),n=[];for(let e=1;e<t.length;e++){const a=t[e].trim();if(a){const e=a.split(",");e.length>=3&&n.push({brand:e[0].trim(),model:e[1].trim(),year:e[2].trim(),created:e[3]?e[3].trim():""})}}return n}(e),console.log(`Loaded ${c.length} vehicles`),function(e){const t=[...new Set(e.map(e=>e.brand))].sort();f(o,t,"Brand");const n=[...new Set(e.map(e=>e.year))].sort((e,t)=>t-e);f(s,n,"Year")}(c),i=c,t.style.display="none",g(),L()}).catch(e=>{console.error("Error loading CSV:",e),t.innerHTML=`\n                <div class="empty-state error-state">\n                    <i class="fas fa-exclamation-circle empty-icon"></i>\n                    <h3>Error Loading Data</h3>\n                    <p>Could not load vehicle database.</p>\n                    <p class="error-details">${e.message}</p>\n                    <button class="retry-btn" onclick="location.reload()">Retry</button>\n                </div>\n            `}),document.addEventListener("click",()=>h(null));const E=document.getElementById("stickySearchWrapper");E&&window.addEventListener("scroll",()=>{window.scrollY>50?E.classList.add("scrolled"):E.classList.remove("scrolled")});const b=document.getElementById("filterSidebar"),w=document.getElementById("filterOverlay"),T=document.getElementById("filterToggleBtn"),B=document.getElementById("closeFilterBtn"),C=document.getElementById("applyFiltersBtn"),k=document.createComment("sidebar-placeholder");function $(){const e=b.classList.contains("open"),t=window.innerWidth<1024;e?(b.classList.remove("open"),w.classList.remove("active"),setTimeout(()=>{if(t&&document.body.contains(b))if(k.parentNode)k.parentNode.insertBefore(b,k),k.parentNode.removeChild(k);else{const e=document.getElementById("stickySearchWrapper");e&&e.appendChild(b)}},400)):(t&&b.parentNode&&(b.parentNode.insertBefore(k,b),document.body.appendChild(b)),w.classList.add("active"),requestAnimationFrame(()=>{b.classList.add("open")}))}T&&T.addEventListener("click",e=>{e.stopPropagation(),$()}),B&&B.addEventListener("click",e=>{e.stopPropagation(),$()}),w&&w.addEventListener("click",$),C&&C.addEventListener("click",()=>{$(),v()});const I=document.getElementById("autocompleteSuggestions");n.addEventListener("input",function(e,t){let n;return function(...a){clearTimeout(n),n=setTimeout(()=>{clearTimeout(n),e(...a)},t)}}(()=>{const e=n.value.toLowerCase().trim();if(e.length>1){const t=function(e){const t=new Set;return c.filter(n=>{const a=`${n.brand} ${n.model}`.toLowerCase();return!(!a.includes(e)||t.has(a)||(t.add(a),0))}).slice(0,5)}(e);!function(e){0!==e.length?(I.innerHTML=e.map(e=>`\n            <div class="suggestion-item">\n                <i class="fas ${p(e.brand)} suggestion-icon"></i>\n                <span>${e.brand} ${e.model}</span>\n            </div>\n        `).join(""),I.classList.add("active"),I.querySelectorAll(".suggestion-item").forEach((t,a)=>{t.addEventListener("click",()=>{const t=e[a];n.value=`${t.brand} ${t.model}`,I.classList.remove("active"),v()})})):I.classList.remove("active")}(t)}else I.classList.remove("active")},300)),document.addEventListener("click",e=>{n.contains(e.target)||I.contains(e.target)||I.classList.remove("active")}),n.addEventListener("focus",()=>{document.body.classList.add("search-focus-mode")}),n.addEventListener("blur",e=>{setTimeout(()=>{n.value.trim()||document.body.classList.remove("search-focus-mode")},200)});const M=document.querySelector(".search-input-group .search-icon");function S(){window.scrollTo({top:0,behavior:"smooth"})}M&&M.addEventListener("click",()=>{v(),document.body.classList.add("search-focus-mode"),n.blur(),setTimeout(S,100)}),n.addEventListener("keypress",e=>{"Enter"===e.key&&(e.preventDefault(),document.body.classList.add("search-focus-mode"),n.blur(),I.classList.remove("active"),setTimeout(S,300))})});